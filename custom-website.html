<!DOCTYPE html>
<html>
<head>
    <title>Compact Website Review</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        .container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .page {
            flex: 1;
            display: none;
        }
        
        .active {
            display: flex;
            flex-direction: column;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            height: 36px;
        }
        
        textarea {
            min-height: 36px;
            resize: none;
            line-height: 1.4;
            padding-top: 8px;
            padding-bottom: 8px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
            height: 36px;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        /* TOP BAR UI */
        .top-bar {
            background: #1a252f;
            color: white;
            padding: 8px 20px;
            display: flex;
            gap: 12px;
            align-items: flex-end;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            flex-wrap: nowrap;
            height: 70px;
            z-index: 100;
        }
        
        .top-bar .form-group {
            flex: 1;
            margin: 0;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .top-bar label {
            font-size: 11px;
            margin-bottom: 3px;
            color: #bdc3c7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .buttons-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .btn-submit { background: #2ecc71; }
        .btn-submit:hover { background: #27ae60; }
        .btn-summary { background: #34495e; }
        
        .website-frame {
            flex: 1;
            border: none;
            background: white;
        }
        
        /* STATUS & UTILS */
        .counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 8px;
            display: none;
            z-index: 2000;
        }
        
        .status-bar {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }

        /* LOGIN CARD */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: #ecf0f1;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
        }

        .summary-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .summary-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }

        .required::after { content: " *"; color: #e74c3c; }
    </style>
</head>
<body>
    <div id="loading" class="loading">Submitting to Google Forms...</div>
    <div id="statusBar" class="status-bar"></div>
    <div id="counter" class="counter" style="display: none;">
        âœ“ <span id="submissionCount">0</span>
    </div>

    <div class="container">
        <!-- Setup Page -->
        <div id="login-page" class="page active">
            <div class="login-container">
                <div class="login-card">
                    <h2 style="margin-top:0; color:#2c3e50;">Review Session Setup</h2>
                    <div class="form-group">
                        <label class="required">Date</label>
                        <input type="date" id="date">
                    </div>
                    <div class="form-group">
                        <label class="required">Review By</label>
                        <select id="review">
                            <option value="">Select Reviewer</option>
                            <option value="Nand Kishor">Nand Kishor</option>
                            <option value="Praveen Agarwal">Praveen Agarwal</option>
                            <option value="Tannu Singh">Tannu Singh</option>
                            <option value="Sumit Rana">Sumit Rana</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="required">Enterprise ID</label>
                        <input type="text" id="enterpriseId" placeholder="Enter your ID">
                    </div>
                    <div class="form-group">
                        <label class="required">Team ID</label>
                        <input type="text" id="teamId" placeholder="Enter Team ID">
                    </div>
                    <div class="form-group">
                        <label class="required">Website URL</label>
                        <input type="text" id="websiteUrl" placeholder="https://www.example.com">
                    </div>
                    <button class="btn" onclick="setupReview()" style="width: 100%; height: 45px; margin-top: 10px;">
                        Start Live Review
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Live Review Page -->
        <div id="review-page" class="page">
            <div class="top-bar">
                <div class="form-group" style="flex: 1.2;">
                    <label class="required">Vin / Stock</label>
                    <input type="text" id="vinStock" placeholder="Enter VIN" autocomplete="off">
                </div>
                
                <div class="form-group" style="flex: 1.5;">
                    <label class="required">Status / Issue</label>
                    <select id="issue">
                        <option value="">-- Select Status --</option>
                        <option value="Stock">Stock</option>
                        <option value="Old Banner">Old Banner</option>
                        <option value="Other stores">Other stores</option>
                        <option value="Without Banner">Without Banner</option>
                        <option value="Non saint Cloud">Non saint Cloud</option>
                        <option value="Raw">Raw</option>
                        <option value="Coming Soon">Coming Soon</option>
                    </select>
                </div>
                
                <div class="form-group" style="flex: 2;">
                    <label>Internal Comment</label>
                    <textarea id="comment" placeholder="Optional notes..."></textarea>
                </div>
                
                <div class="buttons-container">
                    <button onclick="submitReview()" class="btn btn-submit">Submit (Ctrl+Enter)</button>
                    <button onclick="showSummary()" class="btn btn-summary">Stats</button>
                </div>
            </div>
            
            <iframe id="website-frame" class="website-frame"></iframe>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="summary-modal">
        <div class="summary-content">
            <h3 style="margin-top: 0;">Session Statistics</h3>
            <div id="summaryBody" style="font-size: 14px; line-height: 1.6;"></div>
            <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeSummary()" class="btn" style="background: #95a5a6;">Back to Work</button>
                <button onclick="endSession()" class="btn" style="background: #e74c3c;">End & Reset</button>
            </div>
        </div>
    </div>

    <script>
        let submissionCount = 0;
        let sessionData = [];
        let loginData = {};
        
        // Element caching
        const els = {
            login: document.getElementById('login-page'),
            review: document.getElementById('review-page'),
            frame: document.getElementById('website-frame'),
            count: document.getElementById('submissionCount'),
            countBadge: document.getElementById('counter'),
            loading: document.getElementById('loading'),
            status: document.getElementById('statusBar')
        };

        // Inputs
        const inputs = {
            date: document.getElementById('date'),
            reviewer: document.getElementById('review'),
            eid: document.getElementById('enterpriseId'),
            tid: document.getElementById('teamId'),
            url: document.getElementById('websiteUrl'),
            vin: document.getElementById('vinStock'),
            issue: document.getElementById('issue'),
            comment: document.getElementById('comment')
        };

        // Set default date
        inputs.date.valueAsDate = new Date();

        function setupReview() {
            if (!inputs.date.value || !inputs.reviewer.value || !inputs.eid.value || !inputs.tid.value || !inputs.url.value) {
                notify('Missing required setup info', 'error');
                return;
            }

            let finalUrl = inputs.url.value.trim();
            if (!/^https?:\/\//i.test(finalUrl)) finalUrl = 'https://' + finalUrl;

            loginData = {
                date: inputs.date.value,
                reviewer: inputs.reviewer.value,
                eid: inputs.eid.value,
                tid: inputs.tid.value,
                url: finalUrl,
                start: new Date()
            };

            els.frame.src = finalUrl;
            els.login.classList.remove('active');
            els.review.classList.add('active');
            els.countBadge.style.display = 'block';
            
            setTimeout(() => inputs.vin.focus(), 500);
        }

        async function submitReview() {
            const vin = inputs.vin.value.trim();
            const issue = inputs.issue.value;
            const comment = inputs.comment.value.trim();

            if (!vin || !issue) {
                notify('VIN and Status are required', 'error');
                inputs.vin.focus();
                return;
            }

            els.loading.style.display = 'block';

            const payload = {
                ...loginData,
                vin,
                issue,
                comment,
                time: new Date().toISOString()
            };

            const success = await postToGoogle(payload);
            els.loading.style.display = 'none';

            if (success) {
                submissionCount++;
                els.count.textContent = submissionCount;
                sessionData.push(payload);
                notify(`Submitted: ${vin}`, 'success');
                clearEntryForm();
                inputs.vin.focus();
            } else {
                notify('Submission failed. Check connection.', 'error');
            }
        }

        function postToGoogle(data) {
            return new Promise((resolve) => {
                const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSeBICS9bbzhuZ9oJFczlA24CQeD-DrF-so3E3f3smRzYpILow/formResponse';
                
                // Map to Entry IDs from the prefill link provided
                const body = new URLSearchParams();
                body.append('entry.1920772593', data.date);
                body.append('entry.1492030820', data.reviewer);
                body.append('entry.118970267', data.eid);
                body.append('entry.629761069', data.tid);
                body.append('entry.1030198039', data.url);
                body.append('entry.116830960', data.vin);
                body.append('entry.251357690', data.issue);
                body.append('entry.1023639881', data.comment);

                fetch(formUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Google Forms requires no-cors for direct POST
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: body.toString()
                }).then(() => resolve(true))
                  .catch(() => resolve(false));
            });
        }

        function clearEntryForm() {
            inputs.vin.value = '';
            inputs.issue.value = '';
            inputs.comment.value = '';
        }

        function notify(msg, type) {
            els.status.textContent = msg;
            els.status.style.background = type === 'error' ? '#e74c3c' : '#2ecc71';
            els.status.style.display = 'block';
            setTimeout(() => els.status.style.display = 'none', 2500);
        }

        function showSummary() {
            const body = document.getElementById('summaryBody');
            let list = sessionData.slice(-5).reverse().map(d => 
                `<div style="padding:5px 0; border-bottom:1px solid #eee">
                    <strong>${d.vin}</strong>: ${d.issue} 
                    <small style="color:gray; float:right">${new Date(d.time).toLocaleTimeString()}</small>
                </div>`
            ).join('');

            body.innerHTML = `
                <p><strong>Total Submissions:</strong> ${submissionCount}</p>
                <p><strong>Reviewer:</strong> ${loginData.reviewer}</p>
                <hr>
                <p><strong>Recent History:</strong></p>
                ${list || 'No submissions yet.'}
            `;
            document.getElementById('summaryModal').style.display = 'flex';
        }

        function closeSummary() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        function endSession() {
            if (confirm('Are you sure you want to end this session? Data for this session will be cleared from local view.')) {
                location.reload();
            }
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (els.review.classList.contains('active')) {
                if (e.ctrlKey && e.key === 'Enter') submitReview();
                if (e.key === 'Escape') closeSummary();
            }
        });
    </script>
</body>
</html>
